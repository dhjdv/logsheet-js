<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360°SURVEY Pro | Liquid Glass Edition</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Docx.js for Native Word Generation -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* iOS-like Font Stack */
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Liquid Glass UI */
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border-radius: 24px;
        }
        .dark .glass-panel {
            background: rgba(20, 20, 30, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        
        /* Smooth Transitions */
        .transition-all-smooth {
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Marker Styling - Numbered Dots */
        .custom-marker-dot {
            width: 24px;
            height: 24px;
            background: #007AFF; /* iOS Blue */
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            font-family: monospace;
        }
        .marker-hover .custom-marker-dot {
            transform: scale(1.2);
            background: #005ecb;
            z-index: 1001 !important;
        }

        /* Static KML Layer - Bright Yellow */
        .static-layer-path { 
            cursor: default; 
            pointer-events: stroke; 
            stroke: #FFFF00; /* Bright Yellow */
            stroke-width: 3;
            stroke-dasharray: 6, 6; 
            opacity: 0.9; 
        }
        .static-layer-polygon { 
            pointer-events: none !important; 
            fill-color: #FFFF00;
            fill-opacity: 0.1;
            stroke: #FFFF00;
            stroke-width: 2;
        }
        
        /* Precision Cursors - Applied to Map Container */
        .leaflet-container.cursor-crosshair { 
            cursor: crosshair !important; 
        }
        .leaflet-container.cursor-grab { 
            cursor: grab !important; 
        }
        .leaflet-container.cursor-grabbing { 
            cursor: grabbing !important; 
        }
        
        /* Drag & Drop Styling */
        .drag-active {
            border-color: #007AFF !important;
            background-color: rgba(0, 122, 255, 0.1) !important;
            transform: scale(1.02);
        }
        
        /* Print Styles - EXACT 0.5 Inch Margins & Centering */
        @media print {
            @page { 
                size: A4; 
                margin: 0.5in; 
                mso-page-orientation: portrait;
            }
            body { 
                background: white; 
                color: black; 
                margin: 0.5in; 
                padding: 0;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            /* Global Center Alignment for Print */
            body, h1, h2, div, table { text-align: center; }
            
            h1 { font-size: 16pt; font-weight: bold; text-decoration: underline; margin-bottom: 10px; font-family: 'Tahoma', sans-serif !important; }
            .section-title { text-align: left; font-weight: bold; text-decoration: underline; margin-top: 10px; margin-bottom: 5px; font-family: 'Tahoma', sans-serif !important; text-transform: uppercase; }
            
            table { 
                width: 100%; 
                border-collapse: collapse; 
                margin-bottom: 10px;
                margin-left: auto;
                margin-right: auto;
                font-family: 'Tahoma', sans-serif !important;
            }
            tr { page-break-inside: avoid; page-break-after: auto; }
            td, th { 
                border: 1px solid black !important; 
                padding: 4px; 
                font-size: 10pt; 
                text-align: center !important; 
                vertical-align: middle !important;
                font-family: 'Tahoma', sans-serif !important;
            }
            
            /* Strict Page Break */
            .page-break { 
                page-break-before: always; 
                break-before: page;
                display: block;
                height: 0;
                clear: both;
            }
        }
        .print-only { display: none; }
        #error-overlay { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 overflow-hidden h-screen w-screen relative">
    
    <div id="root" class="h-full w-full"></div>
    
    <div id="loading" class="absolute inset-0 z-[9999] bg-white/80 backdrop-blur-md flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center">
            <div class="w-14 h-14 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4 shadow-lg"></div>
            <p class="text-gray-600 font-medium text-sm tracking-wide">Loading...</p>
        </div>
    </div>
    
    <script>
        window.onerror = function(msg) {
            document.getElementById('loading').style.display = 'none';
            alert("App Error: " + msg + ". Please reload.");
            return false;
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, TextRun, AlignmentType, VerticalAlign, HeadingLevel, ImageRun, BorderStyle, HeightRule } = docx;

        // --- Helper Functions ---
        const formatDMS = (decimal, isLat) => {
            if (isNaN(decimal)) return "00°00'00.0000\"";
            const direction = isLat ? (decimal >= 0 ? "N" : "S") : (decimal >= 0 ? "E" : "W");
            const absVal = Math.abs(decimal);
            const deg = Math.floor(absVal);
            const minFull = (absVal - deg) * 60;
            const min = Math.floor(minFull);
            const sec = (minFull - min) * 60;
            const secStr = sec.toFixed(4).padStart(7, '0'); 
            const minStr = min.toString().padStart(2, '0');
            const degStr = deg.toString().padStart(2, '0');
            return `${degStr}°${minStr}'${secStr}"${direction}`;
        };

        const calculateDistance = (p1, p2) => {
            if(!p1 || !p2 || !window.turf) return 0;
            const from = turf.point([p1.lon, p1.lat]);
            const to = turf.point([p2.lon, p2.lat]);
            return turf.distance(from, to, { units: 'meters' });
        };

        const calculateStats = (waypoints, specs) => {
            if (waypoints.length < 2) return { distance: 0, time: 0, battery: 0 };
            let totalDist = 0;
            for (let i = 0; i < waypoints.length - 1; i++) {
                totalDist += calculateDistance(waypoints[i], waypoints[i+1]);
            }
            if(waypoints.length > 2) totalDist += calculateDistance(waypoints[waypoints.length-1], waypoints[0]);
            const timeMin = (totalDist / specs.cruiseSpeed) / 60;
            const batteryUsed = (timeMin / specs.maxFlightTime) * 100;
            return { distance: Math.round(totalDist), time: timeMin.toFixed(1), battery: Math.round(batteryUsed) };
        };

        const parseKMLContent = (xmlText) => {
            try {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                const placemarks = xmlDoc.getElementsByTagName("Placemark");
                const features = [];
                const parseCoords = (node) => {
                    const coordNode = node.getElementsByTagName("coordinates")[0];
                    if (!coordNode) return [];
                    return coordNode.textContent.trim().split(/\s+/).map(str => {
                        const parts = str.split(',');
                        if (parts.length >= 2) return { lat: parseFloat(parts[1]), lon: parseFloat(parts[0]) };
                        return null;
                    }).filter(c => c && !isNaN(c.lat));
                };
                for (let i = 0; i < placemarks.length; i++) {
                    const p = placemarks[i];
                    const name = p.getElementsByTagName("name")[0]?.textContent || `Feature ${i+1}`;
                    const polygons = p.getElementsByTagName("Polygon");
                    for (let j = 0; j < polygons.length; j++) {
                        const coords = parseCoords(polygons[j]);
                        if (coords.length) features.push({ type: 'polygon', coords, name });
                    }
                    const lines = p.getElementsByTagName("LineString");
                    for (let j = 0; j < lines.length; j++) {
                        const coords = parseCoords(lines[j]);
                        if (coords.length) features.push({ type: 'polyline', coords, name });
                    }
                    const points = p.getElementsByTagName("Point");
                    for (let j = 0; j < points.length; j++) {
                        const coords = parseCoords(points[j]);
                        if (coords.length) features.push({ type: 'point', coords: coords[0], name });
                    }
                }
                return features;
            } catch (e) { console.error("KML Error", e); return []; }
        };

        // --- UI Components ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current && iconRef.current.parentNode) {
                    window.lucide.createIcons({
                        root: iconRef.current.parentNode,
                        nameAttr: 'data-lucide',
                        attrs: { class: className, width: size, height: size }
                    });
                }
            }, [name, className, size]);
            return <i ref={iconRef} data-lucide={name} style={{ width: size, height: size, display: 'inline-block' }} className={className}></i>;
        };

        const Tooltip = ({ text, children }) => (
            <div className="group relative flex items-center justify-center">
                {children}
                <div className="absolute -top-10 px-3 py-1.5 bg-gray-900/90 backdrop-blur text-white text-xs font-medium rounded-lg opacity-0 group-hover:opacity-100 transition-all duration-200 transform translate-y-2 group-hover:translate-y-0 shadow-lg pointer-events-none whitespace-nowrap z-50">
                    {text}
                    <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-gray-900/90 rotate-45"></div>
                </div>
            </div>
        );

        // --- Document Generation (DOCX) ---
        const generateDocx = async (project, waypoints, signatureData) => {
            // Font Setting: Tahoma
            const FONT_NAME = "Tahoma";

            // Helper to create a centered text paragraph
            const createText = (text, bold = false, size = 20, underline = false, align = AlignmentType.CENTER, allCaps = false) => {
                return new Paragraph({
                    alignment: align,
                    children: [new TextRun({ 
                        text: text, 
                        bold: bold, 
                        size: size, 
                        font: FONT_NAME, 
                        underline: underline ? { type: "single" } : undefined,
                        allCaps: allCaps
                    })],
                });
            };

            const createCell = (text, bold = false, vMerge = false, type = "continue", rowHeight = false) => {
                const cellProps = {
                    verticalAlign: VerticalAlign.CENTER,
                    margins: { top: 100, bottom: 100, left: 100, right: 100 },
                    children: [createText(text, bold)],
                };
                if (vMerge) {
                    cellProps.verticalMerge = type; // "restart" or "continue"
                }
                return new TableCell(cellProps);
            };

            // 1. General Check Table - FULL PAGE (approx 600-800 twips per row)
            const generalCheckRows = [
                ["1.", "Drone Model Name", "Surveyaan One"],
                ["2.", "Drone Serial Number", "SV12803020"],
                ["3.", "Drone Firmware Version", "1.93"],
                ["4.", "Drone GCS Version", "1.53"],
                ["5.", "Airspace Map", "Location is under green zone as per Airspace Map issued by DGCA"],
                ["6.", "Met condition/ Data", "Normal weather"],
                ["7.", "Wind speed", "Normal below 15 KMPH"],
                ["8.", "Cloudiness", "Bright clear sky"],
                ["9.", "HT line / HT line tower", "None in the fly zone"],
                ["10.", "Height of flight", `${project.altitude}m AGL`],
                ["11.", "Drone Hardware check", "Found OK, no damage seen."],
                ["12.", "Drone Software check", "Found OK."],
                ["13.", "Battery", "Charged above 90%"],
                ["14.", "Take of point", "Plain without disturbance"],
                ["15.", "High rise building", "None in the fly zone"],
            ].map(row => 
                new TableRow({
                    height: { value: 700, rule: HeightRule.AT_LEAST }, // Increase row height to fill page
                    children: [
                        createCell(row[0]),
                        createCell(row[1]),
                        createCell(row[2]),
                    ]
                })
            );

            // 2. Flight Log Table
            const flightLogRows = [];
            
            // Header Row 1
            flightLogRows.push(new TableRow({
                children: [
                    new TableCell({ rowSpan: 2, children: [createText("Date", true)], verticalAlign: VerticalAlign.CENTER }),
                    new TableCell({ rowSpan: 2, children: [createText("Name of Remote Pilot", true)], verticalAlign: VerticalAlign.CENTER }),
                    new TableCell({ columnSpan: 2, children: [createText("Route of flight/ place of operation", true)], verticalAlign: VerticalAlign.CENTER }),
                    new TableCell({ columnSpan: 2, children: [createText("Time of Operation", true)], verticalAlign: VerticalAlign.CENTER }),
                ]
            }));
            
            // Header Row 2
            flightLogRows.push(new TableRow({
                children: [
                    createCell("From", true),
                    createCell("To", true),
                    createCell("Start", true),
                    createCell("Stop", true),
                ]
            }));

            // Data Rows
            const wps = waypoints.length > 0 ? waypoints : [{lat:0,lon:0}, {lat:0,lon:0}];
            const count = Math.max(wps.length, 1);

            // Row 1 (Merged Cells)
            const firstFrom = wps.length > 0 ? `${formatDMS(wps[0].lat, true)}\n${formatDMS(wps[0].lon, false)}` : "";
            const firstTo = wps.length > 1 ? `${formatDMS(wps[1].lat, true)}\n${formatDMS(wps[1].lon, false)}` : (wps.length > 0 ? `${formatDMS(wps[0].lat, true)}\n${formatDMS(wps[0].lon, false)}` : "");

            flightLogRows.push(new TableRow({
                children: [
                    createCell(project.date, true, true, "restart"),
                    createCell(project.pilot, true, true, "restart"),
                    createCell(firstFrom, true),
                    createCell(firstTo, true),
                    createCell(`${project.startTime} HRS`, true, true, "restart"),
                    createCell(`${project.endTime} HRS`, true, true, "restart"),
                ]
            }));

            // Subsequent Rows
            for(let i = 1; i < wps.length; i++) {
                const nextWP = wps[(i + 1) % wps.length]; // Closed loop logic or just segments
                const fromTxt = `${formatDMS(wps[i].lat, true)}\n${formatDMS(wps[i].lon, false)}`;
                const toTxt = `${formatDMS(nextWP.lat, true)}\n${formatDMS(nextWP.lon, false)}`;

                flightLogRows.push(new TableRow({
                    children: [
                        createCell("", true, true, "continue"),
                        createCell("", true, true, "continue"),
                        createCell(fromTxt, true),
                        createCell(toTxt, true),
                        createCell("", true, true, "continue"),
                        createCell("", true, true, "continue"),
                    ]
                }));
            }

            // Signature Logic
            let sigParagraph = new Paragraph({ children: [] });
            
            if (signatureData) {
                // Convert base64 to Uint8Array
                try {
                    const imageResponse = await fetch(signatureData);
                    const imageBlob = await imageResponse.blob();
                    const imageBuffer = await imageBlob.arrayBuffer();
                    
                    sigParagraph = new Paragraph({
                        alignment: AlignmentType.RIGHT,
                        children: [
                            new ImageRun({
                                data: imageBuffer,
                                transformation: { width: 200, height: 100 },
                            }),
                        ],
                        spacing: { before: 400 },
                    });
                } catch(e) { console.error("Sig Error", e); }
            } else {
                sigParagraph = new Paragraph({
                    alignment: AlignmentType.RIGHT,
                    children: [
                        new TextRun({ text: "For R K ENTERPRISES", bold: true, font: FONT_NAME, break: 2 }),
                        new TextRun({ text: "Prop/Manager", bold: true, font: FONT_NAME, break: 4 })
                    ]
                });
            }

            const doc = new Document({
                sections: [{
                    properties: {
                        page: {
                            margin: { top: 720, right: 720, bottom: 720, left: 720 }, // 0.5 inch (1440 = 1 inch)
                        },
                    },
                    children: [
                        createText("DRONE SURVEY LOG SHEET", true, 32, true, AlignmentType.CENTER, true), // Heading 1
                        createText(""), // Spacer
                        new Paragraph({
                            children: [new TextRun({ text: "1. GENERAL CHECK", bold: true, font: FONT_NAME, size: 24, allCaps: true, underline: { type: "single" } })],
                            spacing: { after: 200 }
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [createText("S. No.", true)], width: { size: 10, type: WidthType.PERCENTAGE }, shading: { fill: "F2F2F2" } }),
                                        new TableCell({ children: [createText("Check", true)], width: { size: 40, type: WidthType.PERCENTAGE }, shading: { fill: "F2F2F2" } }),
                                        new TableCell({ children: [createText("Found/ Result/ Remark", true)], width: { size: 50, type: WidthType.PERCENTAGE }, shading: { fill: "F2F2F2" } }),
                                    ]
                                }),
                                ...generalCheckRows
                            ],
                        }),
                        new Paragraph({
                            text: "",
                            pageBreakBefore: true, // FORCE PAGE BREAK
                        }),
                        new Paragraph({
                            text: "2. Flight Log sheet",
                            heading: HeadingLevel.HEADING_2,
                            spacing: { after: 200 }
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: flightLogRows,
                        }),
                        sigParagraph
                    ],
                }],
            });

            return doc;
        };

        const App = () => {
            const [mode, setMode] = useState('navigate');
            const [waypoints, setWaypoints] = useState([]);
            const [staticKmlFeatures, setStaticKmlFeatures] = useState([]); 
            const [activePolyline, setActivePolyline] = useState([]);
            const [kmlFileName, setKmlFileName] = useState("");
            const [signatureImg, setSignatureImg] = useState(null); // Base64
            const [defaultSignature, setDefaultSignature] = useState(null); // Local file fetch
            
            const [project, setProject] = useState({ date: new Date().toISOString().split('T')[0], pilot: "Pretesh Ostwal", location: "Survey Zone", altitude: 80, startTime: "11:30", endTime: "11:46" });
            const [specs, setSpecs] = useState({ cruiseSpeed: 8, maxFlightTime: 30 });
            const [mapType, setMapType] = useState('hybrid');
            const [searchQuery, setSearchQuery] = useState('');
            const [showStaticLayer, setShowStaticLayer] = useState(true);
            const [isSidebarOpen, setSidebarOpen] = useState(true);
            const [dragActive, setDragActive] = useState(false); // Drag state

            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markerRefs = useRef([]);
            const polylineRef = useRef(null);
            const activeDrawRef = useRef(null);
            const staticLayerRefs = useRef([]);
            const fileInputRef = useRef(null);
            const sigInputRef = useRef(null);

            // Attempt to fetch Picture1.png on load
            useEffect(() => {
                const loadSig = async () => {
                    try {
                        const response = await fetch('Picture1.png');
                        if (response.ok) {
                            const blob = await response.blob();
                            const reader = new FileReader();
                            reader.onloadend = () => setDefaultSignature(reader.result);
                            reader.readAsDataURL(blob);
                        }
                    } catch (e) { console.log("Auto signature load skipped (likely not found or CORS)"); }
                };
                loadSig();
                
                const loader = document.getElementById('loading');
                if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.display = 'none', 500); }
                
                const saved = localStorage.getItem('360survey_pro_v23');
                if (saved) {
                    const data = JSON.parse(saved);
                    if (data.waypoints) setWaypoints(data.waypoints);
                    if (data.project) setProject(data.project);
                    if (data.kmlFileName) setKmlFileName(data.kmlFileName);
                    if (data.signatureImg) setSignatureImg(data.signatureImg);
                }
            }, []);

            useEffect(() => { localStorage.setItem('360survey_pro_v23', JSON.stringify({ waypoints, project, kmlFileName, signatureImg })); }, [waypoints, project, kmlFileName, signatureImg]);

            useEffect(() => {
                if (!mapRef.current || mapInstance.current) return;
                try {
                    // Update: Changed initial view to India
                    const map = L.map(mapRef.current, { zoomControl: false }).setView([20.5937, 78.9629], 5);
                    mapInstance.current = map;
                    L.control.zoom({ position: 'bottomright' }).addTo(map);
                    const layers = {
                        street: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }),
                        satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' }),
                        hybrid: L.layerGroup([L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'), L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-lines/{z}/{x}/{y}{r}.png', { opacity: 0.3 })])
                    };
                    layers[mapType].addTo(map);
                    mapInstance.current.layers = layers;
                    if (window.lucide) window.lucide.createIcons();
                } catch(e) {}
            }, []);

            useEffect(() => {
                const map = mapInstance.current;
                if (!map) return;
                map.off('click');
                map.on('click', (e) => {
                    if (mode === 'add_point') {
                        setWaypoints(prev => [...prev, { lat: e.latlng.lat, lon: e.latlng.lng }]);
                    } else if (mode === 'draw_poly') {
                        setActivePolyline(prev => [...prev, { lat: e.latlng.lat, lon: e.latlng.lng }]);
                    }
                });
                const container = document.getElementById('map-container');
                if(container) {
                    if(mode === 'add_point' || mode === 'draw_poly') {
                        L.DomUtil.addClass(map.getContainer(), 'cursor-crosshair');
                        L.DomUtil.removeClass(map.getContainer(), 'cursor-grab');
                    } else {
                        L.DomUtil.removeClass(map.getContainer(), 'cursor-crosshair');
                        L.DomUtil.addClass(map.getContainer(), 'cursor-grab');
                    }
                }
            }, [mode]);

            useEffect(() => {
                const map = mapInstance.current;
                if (!map) return;
                Object.values(map.layers).forEach(l => map.removeLayer(l));
                if(map.layers[mapType]) map.layers[mapType].addTo(map);
            }, [mapType]);

            useEffect(() => {
                const map = mapInstance.current;
                if (!map) return;
                staticLayerRefs.current.forEach(l => map.removeLayer(l));
                staticLayerRefs.current = [];
                if (showStaticLayer && staticKmlFeatures.length > 0) {
                    staticKmlFeatures.forEach(feature => {
                        let layer;
                        const polyStyle = { color: '#FFFF00', weight: 3, opacity: 0.9, fillColor: '#FFFF00', fillOpacity: 0.1, dashArray: '6, 4', className: feature.type === 'polygon' ? 'static-layer-polygon' : 'static-layer-path' };
                        if (feature.type === 'polygon') layer = L.polygon(feature.coords.map(c => [c.lat, c.lon]), polyStyle);
                        else if (feature.type === 'polyline') layer = L.polyline(feature.coords.map(c => [c.lat, c.lon]), polyStyle);
                        else if (feature.type === 'point') layer = L.circleMarker([feature.coords.lat, feature.coords.lon], { radius: 6, fillColor: '#FFFF00', color: '#000', weight: 2, opacity: 1, fillOpacity: 0.8, interactive: false });
                        if (layer) { layer.bindPopup(`Ref: ${feature.name}`); layer.addTo(map); staticLayerRefs.current.push(layer); }
                    });
                }
            }, [staticKmlFeatures, showStaticLayer]);

            useEffect(() => {
                const map = mapInstance.current;
                if (!map) return;
                markerRefs.current.forEach(m => map.removeLayer(m));
                markerRefs.current = [];
                if (polylineRef.current) map.removeLayer(polylineRef.current);
                if (activeDrawRef.current) map.removeLayer(activeDrawRef.current);

                waypoints.forEach((wp, index) => {
                    const icon = L.divIcon({ className: 'bg-transparent', html: `<div class="custom-marker-dot">${index + 1}</div>`, iconSize: [24, 24], iconAnchor: [12, 12] });
                    const marker = L.marker([wp.lat, wp.lon], { icon, draggable: true, zIndexOffset: 1000 }).addTo(map);
                    marker.on('dragend', (e) => { const { lat, lng } = e.target.getLatLng(); setWaypoints(prev => { const newWps = [...prev]; newWps[index] = { lat, lon: lng }; return newWps; }); });
                    marker.on('contextmenu', () => { if(confirm(`Delete Waypoint ${index+1}?`)) setWaypoints(prev => prev.filter((_, i) => i !== index)); });
                    markerRefs.current.push(marker);
                });
                if (waypoints.length > 1) {
                    const latlngs = waypoints.map(wp => [wp.lat, wp.lon]);
                    polylineRef.current = L.polyline(latlngs, { color: '#007AFF', weight: 4, opacity: 0.9, lineCap: 'round', lineJoin: 'round' }).addTo(map);
                }
                if (activePolyline.length > 0) {
                    const drawLatlngs = activePolyline.map(p => [p.lat, p.lon]);
                    activeDrawRef.current = L.polyline(drawLatlngs, { color: '#d946ef', weight: 4, dashArray: '1, 6' }).addTo(map);
                }
            }, [waypoints, activePolyline]);

            const handleDrag = (e) => { e.preventDefault(); e.stopPropagation(); if (e.type === "dragenter" || e.type === "dragover") setDragActive(true); else if (e.type === "dragleave") setDragActive(false); };
            const handleDrop = (e) => {
                e.preventDefault(); e.stopPropagation(); setDragActive(false);
                if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                    const file = e.dataTransfer.files[0];
                    if (file.name.endsWith('.kml')) {
                        processKMLFile(file);
                    } else { alert("Only .kml files are supported."); }
                }
            };

            const processKMLFile = (file) => {
                setKmlFileName(file.name.replace(/\.[^/.]+$/, ""));
                const reader = new FileReader();
                reader.onload = (e) => {
                    const features = parseKMLContent(e.target.result);
                    if (features.length > 0) {
                        setStaticKmlFeatures(features);
                        const c = features[0].coords.length ? features[0].coords[0] : features[0].coords;
                        mapInstance.current.flyTo([c.lat, c.lon], 16);
                    }
                };
                reader.readAsText(file);
            };

            const handleKMLUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                processKMLFile(file);
                event.target.value = '';
            };

            const handleSignatureUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    setSignatureImg(e.target.result); // Base64 string
                };
                reader.readAsDataURL(file);
            };

            const exportDocx = async () => {
                const sigToUse = signatureImg || defaultSignature;
                const doc = await generateDocx(project, waypoints, sigToUse);
                Packer.toBlob(doc).then((blob) => {
                    saveAs(blob, `${kmlFileName || 'DRONE SURVEY LOG SHEET'}.docx`);
                });
            };
            
            const exportKML = () => {
                const kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Flight Plan</name><Style id="path"><LineStyle><color>ff00ff00</color><width>4</width></LineStyle></Style><Placemark><name>Flight Path</name><styleUrl>#path</styleUrl><LineString><coordinates>${waypoints.map(wp => `${wp.lon},${wp.lat},0`).join(' ')}${waypoints.length > 2 ? ` ${waypoints[0].lon},${waypoints[0].lat},0` : ''}</coordinates></LineString></Placemark>${waypoints.map((wp, i) => `<Placemark><name>${i+1}</name><Point><coordinates>${wp.lon},${wp.lat},0</coordinates></Point></Placemark>`).join('')}</Document></kml>`;
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'}));
                a.download = `${kmlFileName || 'DRONE SURVEY LOG SHEET'}.kml`;
                a.click();
            };

            const stats = useMemo(() => calculateStats(waypoints, specs), [waypoints, specs]);

            // Simple HTML Preview for UI (Docx logic handled separately)
            const showPrintPreview = () => {
                window.print();
            };

            return (
                <div className="flex h-screen w-full relative font-sans">
                    <div id="map-container" className="absolute inset-0 z-0 bg-gray-900 cursor-grab"><div ref={mapRef} className="h-full w-full"></div></div>
                    
                    {/* Top Bar - Liquid Glass */}
                    <div className="absolute top-6 left-1/2 transform -translate-x-1/2 z-[1000] w-full max-w-xl px-4 pointer-events-none transition-all-smooth">
                        <div className="flex gap-4 pointer-events-auto">
                            <div className="glass-panel px-6 py-3 flex items-center justify-between w-full shadow-2xl">
                                <div className="flex items-center gap-3 text-blue-600 font-bold"><Icon name="ruler" size={18}/><span>{stats.distance}m</span></div>
                                <div className="h-6 w-px bg-gray-300"></div>
                                <div className="flex items-center gap-3 text-purple-600 font-bold"><Icon name="clock" size={18}/><span>{stats.time}m</span></div>
                                <div className="h-6 w-px bg-gray-300"></div>
                                <div className={`flex items-center gap-3 font-bold ${stats.battery > 85 ? 'text-red-500' : 'text-green-600'}`}><Icon name="battery" size={18}/><span>{stats.battery}%</span></div>
                            </div>
                        </div>
                    </div>

                    {/* Left Sidebar - Liquid Glass */}
                    <div className={`absolute left-6 top-24 bottom-8 w-80 z-[1000] flex flex-col transition-all-smooth ${isSidebarOpen ? 'translate-x-0 opacity-100' : '-translate-x-[120%] opacity-0'}`}>
                        <div className="glass-panel h-full flex flex-col overflow-hidden shadow-2xl">
                            <div className="p-6 border-b border-white/40">
                                <h1 className="font-black text-xl flex items-center gap-3 mb-4 tracking-tight text-gray-800 dark:text-white">
                                    <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg"><Icon name="crosshair" size={22} /></div>
                                    360°SURVEY
                                </h1>
                                <div className="space-y-3">
                                    <input type="text" placeholder="Pilot Name" value={project.pilot} onChange={e => setProject({...project, pilot: e.target.value})} className="w-full bg-white/60 dark:bg-black/20 rounded-xl px-3 py-2 text-sm border border-transparent focus:border-blue-500 focus:bg-white transition-all outline-none"/>
                                    <div className="flex gap-2">
                                        <input type="date" value={project.date} onChange={e => setProject({...project, date: e.target.value})} className="flex-1 bg-white/60 dark:bg-black/20 rounded-xl px-3 py-2 text-sm border border-transparent focus:border-blue-500 focus:bg-white transition-all outline-none"/>
                                        <input type="number" placeholder="Alt (m)" value={project.altitude} onChange={e => setProject({...project, altitude: e.target.value})} className="w-20 bg-white/60 dark:bg-black/20 rounded-xl px-3 py-2 text-sm border border-transparent focus:border-blue-500 focus:bg-white transition-all outline-none"/>
                                    </div>
                                    <div className="flex gap-2 w-full">
                                        <input type="text" placeholder="Start" value={project.startTime} onChange={e => setProject({...project, startTime: e.target.value})} className="flex-1 min-w-0 bg-white/60 dark:bg-black/20 rounded-xl px-3 py-2 text-sm border border-transparent focus:border-blue-500 focus:bg-white transition-all outline-none"/>
                                        <input type="text" placeholder="End" value={project.endTime} onChange={e => setProject({...project, endTime: e.target.value})} className="flex-1 min-w-0 bg-white/60 dark:bg-black/20 rounded-xl px-3 py-2 text-sm border border-transparent focus:border-blue-500 focus:bg-white transition-all outline-none"/>
                                    </div>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 bg-white/20 dark:bg-black/10">
                                {waypoints.map((wp, i) => (
                                    <div key={i} className="flex items-center gap-3 bg-white/80 dark:bg-gray-800/80 p-3 rounded-xl border border-white/40 shadow-sm text-xs hover:scale-[1.02] transition-transform cursor-pointer group">
                                        <div className="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold">{i+1}</div>
                                        <div className="flex-1 font-mono text-[10px] text-gray-600 dark:text-gray-300">{formatDMS(wp.lat, true)}<br/>{formatDMS(wp.lon, false)}</div>
                                        <button onClick={() => setWaypoints(waypoints.filter((_, idx) => idx !== i))} className="p-2 bg-red-50 text-red-500 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                ))}
                                {waypoints.length === 0 && <div className="text-center text-gray-400 text-sm py-10 flex flex-col items-center gap-2"><Icon name="map-pin" size={32} className="opacity-30"/>Click map to add points</div>}
                            </div>
                            <div className="p-4 bg-white/60 dark:bg-black/20 border-t border-white/40">
                                <input type="file" ref={fileInputRef} onChange={handleKMLUpload} accept=".kml" className="hidden" />
                                <input type="file" ref={sigInputRef} onChange={handleSignatureUpload} accept="image/*" className="hidden" />
                                
                                <div 
                                    className={`flex flex-col gap-2 mb-3 p-4 rounded-xl border-2 border-dashed transition-all cursor-pointer ${dragActive ? 'drag-active' : 'border-blue-200 bg-white/40'}`}
                                    onDragEnter={handleDrag} onDragLeave={handleDrag} onDragOver={handleDrag} onDrop={handleDrop}
                                    onClick={() => fileInputRef.current.click()}
                                >
                                    <div className="text-center">
                                        <Icon name="upload-cloud" size={24} className="mx-auto mb-1 text-blue-500"/>
                                        <span className="text-xs font-bold text-gray-600">Drag & Drop KML</span>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={exportDocx} className="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-500/30 transition-all flex items-center justify-center gap-2"><Icon name="file-text" size={16}/> Word (.docx)</button>
                                    <button onClick={exportKML} className="bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-500/30 transition-all flex items-center justify-center gap-2"><Icon name="map" size={16}/> KML</button>
                                    <button onClick={() => sigInputRef.current.click()} className={`col-span-2 py-2 rounded-xl text-xs font-bold shadow-sm border ${signatureImg || defaultSignature ? 'bg-green-100 text-green-700 border-green-300' : 'bg-white/80 text-gray-500 border-gray-200'}`}>
                                        {signatureImg || defaultSignature ? 'Signature Ready' : 'Upload Signature'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button onClick={() => setSidebarOpen(!isSidebarOpen)} className="absolute -right-12 top-8 bg-white/90 backdrop-blur p-3 rounded-xl shadow-xl hover:scale-110 transition-transform"><Icon name={isSidebarOpen ? "chevron-left" : "chevron-right"} size={20}/></button>
                    </div>

                    {/* Bottom Toolbar - Liquid Glass */}
                    <div className="absolute bottom-10 left-1/2 transform -translate-x-1/2 z-[1000]">
                        <div className="glass-panel p-2 flex items-center gap-3 shadow-2xl scale-100 hover:scale-[1.02] transition-transform">
                            <Tooltip text="Pan"><button onClick={() => setMode('navigate')} className={`p-4 rounded-xl transition-all ${mode === 'navigate' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-white/50 text-gray-600'}`}><Icon name="move" size={24}/></button></Tooltip>
                            <div className="w-px h-8 bg-gray-400/30"></div>
                            <Tooltip text="Add Point"><button onClick={() => setMode('add_point')} className={`p-4 rounded-xl transition-all ${mode === 'add_point' ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-white/50 text-gray-600'}`}><Icon name="map-pin" size={24}/></button></Tooltip>
                            <Tooltip text="Draw Path"><button onClick={() => setMode('draw_poly')} className={`p-4 rounded-xl transition-all ${mode === 'draw_poly' ? 'bg-fuchsia-600 text-white shadow-lg' : 'hover:bg-white/50 text-gray-600'}`}><Icon name="pen-tool" size={24}/></button></Tooltip>
                            {mode === 'draw_poly' && activePolyline.length > 0 && <button onClick={() => { setWaypoints(prev => [...prev, ...activePolyline]); setActivePolyline([]); setMode('navigate'); }} className="ml-1 bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg animate-pulse transition-all">Finish</button>}
                            <div className="w-px h-8 bg-gray-400/30"></div>
                            <Tooltip text="Clear"><button onClick={() => confirm("Reset mission?") && setWaypoints([])} className="p-4 rounded-xl hover:bg-red-50 text-red-500 transition-colors"><Icon name="trash-2" size={24}/></button></Tooltip>
                        </div>
                    </div>
                    
                    {/* Layer Controls */}
                    <div className="absolute bottom-10 right-6 z-[1000] flex flex-col gap-3">
                        {staticKmlFeatures.length > 0 && <div className="glass-panel p-2 shadow-xl hover:scale-105 transition-transform"><Tooltip text="Toggle KML"><button onClick={() => setShowStaticLayer(!showStaticLayer)} className={`p-3 rounded-xl transition-colors ${showStaticLayer ? 'bg-cyan-100 text-cyan-600' : 'text-gray-400'}`}><Icon name="layers" size={24}/></button></Tooltip></div>}
                        <div className="glass-panel p-2 flex flex-col gap-2 shadow-xl">
                            <button onClick={() => setMapType('street')} className={`p-3 rounded-xl transition-all ${mapType === 'street' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-500'}`}><Icon name="map" size={24}/></button>
                            <button onClick={() => setMapType('satellite')} className={`p-3 rounded-xl transition-all ${mapType === 'satellite' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-500'}`}><Icon name="satellite" size={24}/></button>
                            <button onClick={() => setMapType('hybrid')} className={`p-3 rounded-xl transition-all ${mapType === 'hybrid' ? 'bg-blue-100 text-blue-600' : 'hover:bg-gray-100 text-gray-500'}`}><Icon name="globe" size={24}/></button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
